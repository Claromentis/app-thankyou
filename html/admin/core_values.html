<!--@head@
<unique_section name="thankyou_component_styles">
	<component class_key="css_loader" src="/intranet/thankyou/css/admin.scss" >
</unique_section>
-->

<block id="admin_breadcrumb">
	<li><a href="/thankyou/admin/">
		<loc name="thankyou:admin:breadcrumb">Thank You</loc>
	</a></li>
	<li class="active">
		<loc name="thankyou:common:tags"></loc>
	</li>
</block>
<block id="info_panel_pills">
	<include file="menu.html"/>
</block>

<block id="page_body">
	<h3>
		<loc name="thankyou:common:tags"></loc>
	</h3>
	<div class="row">
		<div class="col-md-12">
			<cla-toggle-switch name="core_values_enabled" large=""></cla-toggle-switch>
		</div>
	</div>
	<div id="core_values_enabled_body" name="core_values_enabled_body">
		<div class="row">
			<div class="col-md-12">
				<cla-checkbox name="core_values_mandatory"></cla-checkbox>
			</div>
		</div>
		<div class="row">
			<div class="col-md-12 mb-10">
				<cla-button color="success" class="js-tag-create"><loc name="common:create"></loc></cla-button>
			</div>
		</div>
		<component class_key="data_table" name="tags_datatable" service="tags.datatable.admin"/>
	</div>
</block>

<include file="../../common/layouts/admin_with_info_panel.html"/>

<div id="tag_modal" class="modal fade" tabindex="-1" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<form method="post" class="form-horizontal js-tag-form">
				<input type="hidden" name="tag_id"/>
				<input type="hidden" name="csrf_token">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
						aria-hidden="true">&times;</span></button>
					<h4 name="thankyou:common:tags" class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<div class="js-form-error problem-details-title" data-name="problem_details-title"></div>
					<div class="form-group">
						<label name="common:name" class="control-label col-sm-4"></label>
						<div class="form-control-static pt-0 col-sm-8">
							<input name="tag_name">
							<div class="js-form-error" data-name="name"></div>
						</div>
					</div>

					<div class="form-group">
						<label class="control-label col-sm-4">
							<loc name="common:background_colour"></loc>
						</label>
						<div class="col-sm-8">
							<input type="text" name="tag_bg_colour" id="tag_bg_colour"
								   class="js-color-confirm js-no-white form-control kolorPicker"/>

							<div class="js-form-error" data-name="bg_colour"></div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button name="thankyou:component:modal:close" class="btn btn-default" data-dismiss="modal"
							aria-hidden="true">Close
					</button>
					<button name="thankyou:component:modal:submit" class="btn btn-primary">Submit</button>
				</div>
			</form>
		</div>
	</div>
</div>

<div id="tag_delete_modal" class="modal fade" tabindex="-1" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<input type="hidden" name="id"/>
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				<h4 name="thankyou:tag:delete:title" class="modal-title"></h4>
			</div>
			<div class="modal-body">
				<div class="js-form-error" data-name="problem_details-title" style="text-align: center;"></div>
				<loc name="thankyou:tag:delete:description"></loc>
			</div>
			<div class="modal-footer">
				<button class="btn btn-default" data-dismiss="modal">
					<span name="thankyou:component:modal:close" aria-hidden="true"></span>
				</button>
				<button name="common:delete" class="btn btn-primary js-tag-delete-submit"></button>
			</div>
		</div>
	</div>
</div>

<script type="text/template" id="js_modal_error_template">
	<span class="text-danger"></span>
</script>
<script type="text/javascript">
    require(['domReady', 'jquery', 'colour_picker'], function(domReady, $) {
        domReady(function () {

		});
	});

	(function ($) {
        $('cla-toggle-switch[name="core_values_enabled"]').on('change', function () {
            var checked = $(this).find('input').prop('checked');

            var body = {
                'thankyou_core_values_enabled': checked
            };

            $.ajax({
                url: '/api/thankyou/v2/admin/config',
                type: 'POST',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify(body)
            }).done(function (response) {
                if (response) {
                    if (checked) {
                        $('#core_values_enabled_body').slideDown("fast");
                    } else {
                        $('#core_values_enabled_body').hide();
                    }
                }
            });
        });

        $('cla-checkbox[name="core_values_mandatory"]').on('change', function () {
            var checked = $(this).find('input').prop('checked');

            var body = {
                'thankyou_core_values_mandatory': checked
            };

            $.ajax({
                url: '/api/thankyou/v2/admin/config',
                type: 'POST',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify(body)
            });
        });

        var core_values = $('#core_values_enabled_body');

        core_values.on('click', '.js-tag-create', function () {
            tag_modal.resetForm();
            tag_modal.showModal(true);
        });

        core_values.on('click', '.js-tag-active', function () {
            tag_modal.setActive($(this).parent().attr('data-id'), $(this).attr('data-value'));
		});

        core_values.on('click', '.js-tag-edit', function () {
            tag_modal.populateFromId($(this).parent().attr('data-id'));
		});

        core_values.on('click', '.js-tag-delete', function () {
            tag_delete_modal.populateFromId($(this).parent().attr('data-id'));
        });

        $('.js-tag-form').on('submit', function (event) {
            event.preventDefault();
            tag_modal.submit();
		});

        var tag_modal = {
            modal: $('#tag_modal'),
			error_template: $('#js_modal_error_template'),
            setActive: function (id, active) {
                var self = this;
                active = !(active === "0" || active === 0);
                $.ajax({
					url: '/api/thankyou/v2/tags/' + id,
					type: 'POST',
					dataType: 'json',
					contentType: 'application/json',
					data: JSON.stringify({active: active})
				}).done(function () {
				    self.reloadDataTable();
                });
            },
			populateFromId: function (id) {
                var self = this;
                $.ajax({
					url: '/api/thankyou/v2/tags/' + id
				}).done(function(data){
                    self.populateFromTag(data);
                })
			},
			populateFromTag: function (tag) {
                this.modal.find('input[name="tag_id"]').val(+tag.id);
                this.modal.find('input[name="tag_name"]').val(tag.name);
                this.modal.find('input[name="tag_bg_colour"]').val(tag.bg_colour);
                this.resetErrors();
                this.showModal(true);
			},
			showModal: function (show) {
                if (show === true) {
                    this.modal.modal('show');
				} else {
                    this.modal.modal('hide');
				}
			},
			reloadDataTable: function () {
                $('#tags_datatable table').dataTable().api().ajax.reload();
			},
			resetForm: function () {
                this.modal.find('input[name="tag_id"]').val(null);
                this.modal.find('input[name="tag_name"]').val(null);
                this.modal.find('input[name="tag_bg_colour"]').val(null);

                this.resetErrors();
			},
			resetErrors: function () {
                var form_errors = this.modal.find('.js-form-error');
                form_errors.empty();
			},
			submit: function () {
                var self = this;

                self.resetErrors();

                var id = +this.modal.find('input[name="tag_id"]').val();
                if (!(id > 0)) {
                    id = null;
				}
                var name = this.modal.find('input[name="tag_name"]').val();
                var bg_colour = this.modal.find('input[name="tag_bg_colour"]').val();

                var body = {
                    name: name,
					bg_colour: bg_colour
				};

                var url = '/api/thankyou/v2/tags';
                if (id !== null) {
                    url += '/' + id;
				}

                $.ajax({
                    url: url,
                    type: 'POST',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify(body),
					error: function (response) {
                        var body = response.responseJSON;

                        var form_errors = self.modal.find('.js-form-error');
                        var problem_details_title_error = form_errors.filter('[data-name="problem_details-title"]');
                        if (problem_details_title_error.length > 0 && 'title' in body) {
                            self.addError(problem_details_title_error, body.title);
						}

                        if ('invalid-params' in body) {
                            for (var offset in body['invalid-params']) {
                                var invalid_param = body['invalid-params'][offset];
                                if ('name' in invalid_param) {
                                    var error_container = form_errors.filter('[data-name="' + invalid_param.name + '"]');
                                    if (error_container.length > 0 && 'reason' in invalid_param) {
                                        self.addError(error_container, invalid_param.reason);
									}
								}
							}
						}
					},
					success: function () {
                        self.showModal(false);
                        self.reloadDataTable();
					}
                });
			},
			addError: function (container, message) {
                var error = $(_.template(this.error_template.html())({}));
                error.text(message);
                container.append(error);
			}
		};

        var tag_delete_modal = {
            modal: $('#tag_delete_modal'),
            error_template: $('#js_modal_error_template'),
            resetErrors: function () {
                var form_errors = this.modal.find('.js-form-error');
                form_errors.empty();
            },
            populateFromId: function (id) {
                this.modal.find('input[name="id"]').val(id);
                this.resetErrors();
                this.showModal(true);
			},
            showModal: function (show) {
                if (show === true) {
                    this.modal.modal('show');
                } else {
                    this.modal.modal('hide');
                }
            },
			submit: function () {
                var self = this;

                self.resetErrors();

                var id = this.modal.find('input[name="id"]').val();

                $.ajax({
                    url: '/api/thankyou/v2/tags/' + id,
                    type: 'DELETE',
                    dataType: 'json',
                    contentType: 'application/json',
                    error: function (response) {
                        var body = response.responseJSON;

                        var form_errors = self.modal.find('.js-form-error');
                        var problem_details_title_error = form_errors.filter('[data-name="problem_details-title"]');
                        if (problem_details_title_error.length > 0 && 'title' in body) {
                            self.addError(problem_details_title_error, body.title);
                        }
                    },
                    success: function () {
                        self.showModal(false);
                        self.reloadDataTable();
                    }
                });
			},
            addError: function (container, message) {
                var error = $(_.template(this.error_template.html())({}));
                error.text(message);
                container.append(error);
            },
            reloadDataTable: function () {
                $('#tags_datatable table').dataTable().api().ajax.reload();
            }
		};

        tag_delete_modal.modal.find('.js-tag-delete-submit').on('click', function () {
            tag_delete_modal.submit();
		});

    })(jQuery);
</script>
